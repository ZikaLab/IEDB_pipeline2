#!/usr/local/bin/perl
# Derived from iedb_output_parse_v0-4.pl; ref-only adaptation and thresholds customized.
# author: Michael W. Gaunt, Ph.D
use strict;
use warnings;

# Args: OUTPUT_DIR (required), INPUT_DIR (required)
my $CLI_OUTPUT_DIR = defined $ARGV[0] ? $ARGV[0] : '';
my $CLI_INPUT_DIR  = defined $ARGV[1] ? $ARGV[1] : '';
if (!$CLI_OUTPUT_DIR) { die "No output directory specified\n"; }
if (!$CLI_INPUT_DIR)  { die "No input directory specified\n"; }
$CLI_OUTPUT_DIR .= '/' unless $CLI_OUTPUT_DIR =~ /\/$/;
$CLI_INPUT_DIR  .= '/' unless $CLI_INPUT_DIR  =~ /\/$/;

#####################################################################################################
#####################################################################################################
#### The alignment MUST EXACTLY of format Ce(tab)sequence any variation will be identified ##
#### by incongruence in the "triple verified" array      ##
#### The reference sequences used follow the same format              ##
#####################################################################################################
#####################################################################################################
my $cd8_type = 'anticancer_test_';

# Define base directory and alignment location (use environment variable or default)
my $here = $ENV{'BASE_DIR'} ? $ENV{'BASE_DIR'} . '/' : '/Users/michael_gaunt/Desktop/Anastasia/';
$here .= '/' unless $here =~ /\/$/;  # Ensure trailing slash
my $align_loc = $here . 'data/';

# Load CD8_list from params/CD_type.dat
my @CD8_list = load_cd8_list($here);

# Modified master_files to use CSV reference file
my %master_files = (
	'/ref_output/' => 'anticancer_test-ref.csv'
	);

# Global variables to store dynamic reference sequences (set after loading alignment)
my @reference_sequences = ();

# Threshold parameters (kept same as v0-4)
my $PERCENTILE_THRESHOLD = 40.0;      # Maximum percentile rank for peptides to be included (<=40.0)
my $PERCENTAGE_IDENTITY_THRESHOLD = 0.999999;  # Require ~100% identity

main ();

sub load_cd8_list {
	my ($base_dir) = @_;
	my @cd8_default = ('HLA-A*01:01','HLA-A*02:01');
	
	my $params_file = $base_dir . 'params/CD_type.dat';
	unless (-f $params_file) {
		warn "Warning: $params_file not found, using default CD8_list\n";
		return @cd8_default;
	}
	
	my @cd8_list = ();
	open(my $fh, '<', $params_file) or do {
		warn "Warning: Cannot open $params_file: $!, using default CD8_list\n";
		return @cd8_default;
	};
	
	while (my $line = <$fh>) {
		chomp $line;
		$line =~ s/^\s+|\s+$//g;  # Trim whitespace
		next if $line =~ /^\s*$/;  # Skip empty lines
		next if $line =~ /^#/;     # Skip comments
		
		# Validate that value is in quotes
		unless ($line =~ /^'([^']+)'[,]?$/) {
			die "Error in $params_file: Values must be in single quotes. Found: $line\n";
		}
		
		my $allele = $1;
		push @cd8_list, $allele;
	}
	close $fh;
	
	if (scalar(@cd8_list) == 0) {
		warn "Warning: No valid CD8 entries found in $params_file, using default\n";
		return @cd8_default;
	}
	
	return @cd8_list;
}

sub load_length_range {
	my ($base_dir) = @_;
	my $length_min_default = 8;
	my $length_max_default = 10;
	
	my $params_file = $base_dir . 'params/length.dat';
	unless (-f $params_file) {
		warn "Warning: $params_file not found, using default range ($length_min_default..$length_max_default)\n";
		return ($length_min_default, $length_max_default);
	}
	
	open(my $fh, '<', $params_file) or do {
		warn "Warning: Cannot open $params_file: $!, using default range ($length_min_default..$length_max_default)\n";
		return ($length_min_default, $length_max_default);
	};
	
	my $line = <$fh>;
	close $fh;
	
	if (!$line) {
		warn "Warning: Empty $params_file, using default range ($length_min_default..$length_max_default)\n";
		return ($length_min_default, $length_max_default);
	}
	
	chomp $line;
	$line =~ s/^\s+|\s+$//g;
	
	# Parse format: "8, 11" or "8,11"
	if ($line =~ /^(\d+)\s*,\s*(\d+)$/) {
		my $min = $1;
		my $max = $2;
		unless ($min > 0 && $max >= $min) {
			die "Error in $params_file: Invalid range. min=$min, max=$max. min must be > 0 and max >= min\n";
		}
		return ($min, $max);
	} else {
		die "Error in $params_file: Invalid format. Expected 'min, max' (e.g., '8, 10'). Found: $line\n";
	}
}

sub main {
	# Load length range from params/length.dat
	my ($length_min, $length_max) = load_length_range($here);
	
    for my $directory (sort keys %master_files){
        my $align = $master_files{$directory};
        for my $store_no ($length_min..$length_max){
            # Use CLI-provided directories
            my $iedb_out = $CLI_INPUT_DIR;
            my $output_dir = $CLI_OUTPUT_DIR;
            system("mkdir -p $output_dir") unless -d $output_dir;
            my %hash_counts;
            my $flag = 0;
            my ($loci, $size, $outfile, $summary);
            file_begin ($align, $output_dir, $flag, $cd8_type);
            foreach my $cd8 (@CD8_list){
                my ($alignment_, $locus_) = load_align (\$align_loc, \$align, \$cd8);
                my $iedb_parsed = parse_iedb($iedb_out, $alignment_, $cd8, $store_no);
                my $iedb_true_loc = epitope_locations ($iedb_parsed, $cd8);
                my $iedb_prot_id = amino_acid_diffs ($iedb_true_loc, $cd8);
                my $iedb_final_db = epitope_reference_match ($iedb_prot_id, $cd8);
                my $hash_counter;
                ($loci, $size, $outfile, $summary, $hash_counter) = iedb_printout (\%hash_counts, $iedb_final_db, $cd8, $output_dir, $locus_, $flag, $cd8_type);
                %hash_counts = %{$hash_counter};
                $flag = 1;
            }
            my $summary_stuff = file_clean ($loci, $output_dir, $size, $outfile, $summary, $cd8_type, $store_no);
            final_average (\%hash_counts, $summary_stuff);
        }
    }
}

# The rest of the script is adapted from v0-4 (robust parsing and printing)
sub load_align { my ($align_location, $align_, $cd8_) = @_; my %alignment; my @sequence_order = (); (my $locus = $$align_) =~ s/\.(phy|csv)//; open (my $fh, '<', "$$align_location$$align_") or die "The original alignment file will not open\n" . "$!"; my $header = <$fh>; while (<$fh>){ my $line = $_; chomp $line; next unless $line =~ /\S/; my ($virus, $data) = split(/[\t ]+/, $line, 2); $virus = '' unless defined $virus; $data = '' unless defined $data; $virus =~ s/^\s+|\s+$//g; $data =~ s/^\s+|\s+$//g; next unless $virus && $virus =~ /\S/ && $data && $data =~ /^[A-Z-]+$/; push @sequence_order, $virus unless exists $alignment{$virus}; my $gap_positions = gaps($data); (my $dealign = $data) =~ s/-//g; $alignment{$virus}->{'aligned_locus'} = $locus; $alignment{$virus}->{'gaps'} = $gap_positions; $alignment{$virus}->{'protein'} = $data; $alignment{$virus}->{'dealign_protein'} = $dealign; $alignment{$virus}->{$$cd8_}->{'ANN'} = (); $alignment{$virus}->{$$cd8_}->{'SMM'} = (); $alignment{$virus}->{$$cd8_}->{'Epitopes'} = (); $alignment{$virus}->{$$cd8_}->{'Epitope_loc'} = (); $alignment{$virus}->{$$cd8_}->{'Index_epi_location'} = (); $alignment{$virus}->{$$cd8_}->{'Size'} = (); $alignment{$virus}->{$$cd8_}->{'Consensus'} = (); $alignment{$virus}->{$$cd8_}->{'Error'} = (); $alignment{$virus}->{$$cd8_}->{'Gold_location'} = (); $alignment{$virus}->{$$cd8_}->{'Epitope_homologue_penultimate'} = (); $alignment{$virus}->{$$cd8_}->{'Epitope_homologue_confirmed'} = (); $alignment{$virus}->{$$cd8_}->{'Indel_epitope_reference'} = {}; $alignment{$virus}->{$$cd8_}->{'amino_acid_homology'} = {}; $alignment{$virus}->{$$cd8_}->{'amino_acid_identity'} = {}; $alignment{$virus}->{$$cd8_}->{'amino_acid_differences'} = {}; } close $fh; if (scalar(@sequence_order) >= 2) { @reference_sequences = @sequence_order[0..1]; } elsif (scalar(@sequence_order) == 1) { @reference_sequences = ($sequence_order[0]); } else { @reference_sequences = keys %alignment; @reference_sequences = @reference_sequences[0..1] if scalar(@reference_sequences) >= 2; } return (\%alignment, $locus); }
sub gaps { my ($data_1) = @_; my $s = 0; my @c; my $i; for ($i = 0; $i <= length($data_1); $i++) { my $d = substr($data_1, $i, 1); if ($d eq "-") { push(@c, $i + 1); } } return \@c; }
sub load_iedb { my ($input, $peptide_length) = @_; $peptide_length = '' unless defined $peptide_length; opendir (my $fh1, "$input") or die "I can not find the infiles" . "$!"; my @rf; if ($peptide_length && $peptide_length =~ /^\d+$/) { my $length_pattern = quotemeta(".$peptide_length") . "_"; @rf = grep{/HLA/ && /\.csv\.tsv$/ && /$length_pattern/} readdir($fh1); } else { @rf = grep{/HLA/ && /\.csv\.tsv$/} readdir($fh1); } closedir $fh1; return \@rf; }
sub parse_iedb { my ($in, $alignment_2, $cd8_2, $peptide_length) = @_; $peptide_length = '' unless defined $peptide_length; my $iedb_files = load_iedb($in, $peptide_length); my %files_by_virus = (); foreach my $file (@$iedb_files) { chomp $file; my $flag_virus = checker ($alignment_2, $file); next unless $flag_virus == 1; (my $cd8_check = $file) =~ s/.*(HLA.*?)\+(\d+\:\d+)\..*/$1\*$2/; next unless $cd8_check eq $cd8_2; (my $virus_2_file = $file) =~ s/^(.+?)__.*/$1/; my $virus_2 = ''; foreach my $align_key (keys %{$alignment_2}) { if ($align_key =~ /\Q$virus_2_file\E/ || $virus_2_file =~ /\Q$align_key\E/) { $virus_2 = $align_key; last; } } $virus_2 = $virus_2_file unless $virus_2; push @{$files_by_virus{$virus_2}}, $file; } foreach my $virus_2 (keys %files_by_virus) { my %peptide_index = (); unless (exists $alignment_2->{$virus_2}) { warn "Warning: Virus $virus_2 not found in alignment - skipping files\n"; next; } unless (defined $alignment_2->{$virus_2}->{$cd8_2}) { $alignment_2->{$virus_2}->{$cd8_2} = {}; } unless (exists $alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'}) { $alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Size'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Consensus'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'ANN'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'SMM'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Epitope_loc'} = []; } foreach my $file (@{$files_by_virus{$virus_2}}){ open (my $fh2, '<', "$in$file") or die "I can not find the IEDB output file\t$!"; my $header2 = <$fh2>; while (<$fh2>){ my $results = $_; chomp $results; next unless $results =~ m/^HLA/; my ($allele_check, $peptide, $score_or_ic50, $percentile) = split("\t", $results); next unless defined $percentile && $percentile =~ /^\d+(\.\d+)?$/; next unless $percentile <= $PERCENTILE_THRESHOLD; my $method = ''; if ($file =~ /_smm\.csv\.tsv$/) { $method = 'smm'; } elsif ($file =~ /_ann\.csv\.tsv$/) { $method = 'ann'; } elsif ($file =~ /_comblib.*\.csv\.tsv$/) { $method = 'comblib'; } my $pep_idx; my $peptide_key = "$peptide:$method"; if (exists $peptide_index{$peptide_key}) { next; } else { unless (defined $alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'}) { $alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Size'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Consensus'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'ANN'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'SMM'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Comblib'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Method'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Method_percentile'} = []; $alignment_2->{$virus_2}->{$cd8_2}->{'Epitope_loc'} = []; } $pep_idx = scalar(@{$alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'}}); $peptide_index{"$peptide:$method"} = $pep_idx; my $epi_size = length($peptide); unless (exists $alignment_2->{$virus_2} && exists $alignment_2->{$virus_2}->{'protein'}) { warn "Warning: Virus $virus_2 not found in alignment for peptide $peptide - skipping\n"; next; } my $target_protein = $alignment_2->{$virus_2}->{'protein'}; my $epi_loc_begin = index($target_protein, $peptide) + 1; $epi_loc_begin = 1 if $epi_loc_begin == 0; my $epi_loc_end = $epi_loc_begin + $epi_size - 1; push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Epitopes'}}, $peptide); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Size'}}, $epi_size); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Consensus'}}, $percentile); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Method'}}, uc($method)); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Method_percentile'}}, $percentile); my $ann_val = ($method eq 'ann') ? $score_or_ic50 : "0.0000"; my $smm_val = ($method eq 'smm') ? $score_or_ic50 : "0.0000"; my $comblib_val = ($method eq 'comblib') ? $score_or_ic50 : "0.0000"; push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'ANN'}}, $ann_val); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'SMM'}}, $smm_val); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Comblib'}}, $comblib_val); my @tmp_array = ($epi_loc_begin, $epi_loc_end); push (@{$alignment_2->{$virus_2}->{$cd8_2}->{'Epitope_loc'}}, \@tmp_array); } } close $fh2; } } return $alignment_2; }
sub checker { my ($alignment_2, $file_) = @_; my $flag_virus = 0; (my $peptide_from_file = $file_) =~ s/(.*)__.*/$1/; foreach my $virus_check (keys %{$alignment_2}){ if ($virus_check =~ /\Q$peptide_from_file\E/ || $peptide_from_file =~ /\Q$virus_check\E/) { $flag_virus = 1; last; } } return $flag_virus; }
sub epitope_locations { my ($alignment_3, $cd8_3) = @_; for my $virus_3 (keys %$alignment_3){ my @mrcool; my @triple_verified; my @error; my $i = 0; my $flag_3; next unless defined $alignment_3->{$virus_3}->{$cd8_3}->{'Epitopes'}; foreach my $epitope_peptide (@{$alignment_3->{$virus_3}->{$cd8_3}->{'Epitopes'}}){ my $epitope_value1 = index($alignment_3->{$virus_3}->{'protein'}, $epitope_peptide) + 1; my $epitope_value2 = rindex($alignment_3->{$virus_3}->{'protein'}, $epitope_peptide) + 1; my $cool = $epitope_value1 if $epitope_value1 eq $epitope_value2; $cool = $epitope_value1 . "-" . $epitope_value2 if $epitope_value1 != $epitope_value2; push (@mrcool, $cool); my ($check_locus, $check_locus2, $flag_3) = check_epitope($virus_3, $alignment_3, $cd8_3, $i); if ($cool =~ m/-/){ push (@triple_verified, $check_locus); } else { push (@triple_verified, $check_locus) if $check_locus == $cool; } my $tmp_val = "$epitope_value1-$epitope_value2-$check_locus-$check_locus2"; push (@triple_verified, $tmp_val) if $epitope_value1 != $check_locus; ($triple_verified[$i] =~ m/-/ ? $flag_3 : $flag_3) = ($triple_verified[$i] =~ m/-/ ? 1 : 0); push (@error, $flag_3); $i++; $flag_3 = 0; } $alignment_3->{$virus_3}->{$cd8_3}->{'Index_epi_location'} = \@mrcool; $alignment_3->{$virus_3}->{$cd8_3}->{'Gold_location'} = \@triple_verified; $alignment_3->{$virus_3}->{$cd8_3}->{'Error'} = \@error; } return $alignment_3; }
sub check_epitope { my ($virus_4, $alignment_4, $cd8_4, $i_) = @_; my $counter = 0; my $flag_4; my $epi_loc = $alignment_4->{$virus_4}->{$cd8_4}->{'Epitope_loc'}->[$i_]->[0]; my $epi_loc2 = $alignment_4->{$virus_4}->{$cd8_4}->{'Epitope_loc'}->[$i_]->[1]; foreach my $gap_loc (@{$alignment_4->{$virus_4}->{'gaps'}}){ if ($epi_loc <= $gap_loc) {last;} else { $epi_loc = $epi_loc + 1; $counter++; } } foreach my $gap_loc (@{$alignment_4->{$virus_4}->{'gaps'}}){ if ($epi_loc2 <= $gap_loc) {last;} else { $epi_loc2 = $epi_loc2 + 1; } } return ($epi_loc, $epi_loc2, $flag_4); }
sub amino_acid_diffs { my ($alignment_5, $cd8_5) = @_; my @ZIKV_JEV = @reference_sequences; if (scalar(@ZIKV_JEV) == 0) { my @available_sequences = keys %$alignment_5; @ZIKV_JEV = @available_sequences[0..1] if scalar(@available_sequences) >= 2; @ZIKV_JEV = ($available_sequences[0]) if scalar(@available_sequences) == 1; } for my $virus_5 (keys %$alignment_5){ next unless defined $alignment_5->{$virus_5}->{$cd8_5}->{'Epitopes'}; foreach my $reference (@ZIKV_JEV){ my @homology = (); my @all_amino_acids_epitopes = (); my @final_homologue = (); my @aa_identity = (); my @differences; my @gap_epitope_reference = (); my $a = 0; my $ref_peptide = $alignment_5->{$reference}->{'protein'}; my $target_peptide = $alignment_5->{$virus_5}->{'protein'}; foreach my $epitope_peptide (@{$alignment_5->{$virus_5}->{$cd8_5}->{'Epitopes'}}){ my $gap_ref_start; my $gap_ref_end; my $homologue_gap; my $target_gap; my $homologue; my $flag_5 = 0; my $death_flag = 0; my $multiply = $alignment_5->{$virus_5}->{$cd8_5}->{'Size'}->[0]; $epitope_peptide = 'X' x  $multiply if $epitope_peptide =~ /\d+/; my $ref_position = $alignment_5->{$virus_5}->{$cd8_5}->{'Gold_location'}->[$a]; chomp $ref_position if defined $ref_position; $ref_position = '' unless defined $ref_position; my $numeric_position = 0; if ($ref_position =~ m/\d+\-\d+\-\d+\-\d+/){ $flag_5 = 1; my ($a_temp, $b_temp, $gap_ref_start, $gap_ref_end) = split ("-", $ref_position); $numeric_position = $gap_ref_start; my $gap_length = ($gap_ref_end - $gap_ref_start) + 1; $homologue_gap = substr ($ref_peptide, $gap_ref_start - 1, $gap_length); $target_gap = substr ($target_peptide, $gap_ref_start - 1, $gap_length); if ($homologue_gap =~ m/-/) { $homologue = $homologue_gap; } else { $death_flag = 1; $homologue = "undef";} ($target_gap =~ m/-/ ? $epitope_peptide : $death_flag) = ($homologue_gap =~ m/-/ ? $target_gap : 1); push @gap_epitope_reference, $homologue_gap; } elsif ($ref_position =~ /^\d+$/) { $numeric_position = $ref_position; $flag_5 = 0; if ($numeric_position > 0 && $numeric_position <= length($ref_peptide)) { $homologue = substr ($ref_peptide, $numeric_position - 1, length($epitope_peptide)); if (defined $homologue && length($homologue) > 0){ push @gap_epitope_reference, "$homologue"; } else { push @gap_epitope_reference, $epitope_peptide; } } else { my $pep_pos = index($ref_peptide, $epitope_peptide); if ($pep_pos >= 0) { $homologue = substr($ref_peptide, $pep_pos, length($epitope_peptide)); push @gap_epitope_reference, "$homologue"; } else { $death_flag = 1; push @gap_epitope_reference, "-1"; } } } else { $flag_5 = 0; my $pep_pos = index($ref_peptide, $epitope_peptide); if ($pep_pos >= 0) { $numeric_position = $pep_pos + 1; $homologue = substr($ref_peptide, $pep_pos, length($epitope_peptide)); push @gap_epitope_reference, "$homologue"; } else { $death_flag = 1; push @gap_epitope_reference, "-1"; } } if (defined $homologue && $homologue =~ m/-/ and $flag_5 == "0"){ $death_flag = 1; }; my @target_peptide = split(//, $epitope_peptide); my @ref_peptide = (); if (defined $homologue && length($homologue) > 0) { @ref_peptide = split(//, $homologue); } my $counter = 0; my $matches = 0; for (my $i = 0; $i <= $#target_peptide; $i++) { last unless $death_flag == 0; $target_peptide[$i] = 'X' unless defined $target_peptide[$i]; next if $target_peptide[$i] =~ m/-/; next unless defined $ref_peptide[$i]; $counter++; if($target_peptide[$i] eq $ref_peptide[$i]){ $matches++; } } if ($death_flag == 0){ push @aa_identity, $matches; push @all_amino_acids_epitopes, $counter; push @homology, ($matches/$counter); push @differences, ($counter - $matches); push @final_homologue, $alignment_5->{$virus_5}->{$cd8_5}->{$cd8_5}->{'Gold_location'}->[$a]; } else { push @aa_identity, "0"; push @homology, "0"; push @differences, "0"; push @final_homologue, "0"; } $a++; } $alignment_5->{$virus_5}->{$cd8_5}->{'Epitope_homologue_penultimate'} = \@final_homologue; $alignment_5->{$virus_5}->{$cd8_5}->{'all_amino_acids_epitopes'}->{$reference}  = \@all_amino_acids_epitopes; $alignment_5->{$virus_5}->{$cd8_5}->{'amino_acid_homology'}->{$reference} = \@homology; $alignment_5->{$virus_5}->{$cd8_5}->{'amino_acid_identity'}->{$reference} = \@aa_identity; $alignment_5->{$virus_5}->{$cd8_5}->{'amino_acid_differences'}->{$reference} = \@differences; $alignment_5->{$virus_5}->{$cd8_5}->{'Indel_epitope_reference'}->{$reference} = \@gap_epitope_reference; } } return $alignment_5; }
sub epitope_reference_match { my ($alignment_6, $cd8_6) = @_; my @ZIKV_JEV = @reference_sequences; if (scalar(@ZIKV_JEV) == 0) { my @available_sequences = keys %$alignment_6; @ZIKV_JEV = @available_sequences[0..1] if scalar(@available_sequences) >= 2; @ZIKV_JEV = ($available_sequences[0]) if scalar(@available_sequences) == 1; } for my $virus_6 (keys %$alignment_6){ foreach my $reference_ (@ZIKV_JEV){ my @homologue_ = (); next unless defined $alignment_6->{$virus_6}->{$cd8_6}->{'Epitope_homologue_penultimate'}; next unless defined $alignment_6->{$virus_6}->{$cd8_6}->{'Epitopes'}; my %ref_peptides_by_sequence = (); my $ref_protein_seq = $alignment_6->{$reference_}->{'protein'}; if (defined $alignment_6->{$reference_}->{$cd8_6}->{'Epitopes'}) { my $ref_idx = 0; foreach my $ref_pep (@{$alignment_6->{$reference_}->{$cd8_6}->{'Epitopes'}}) { $ref_peptides_by_sequence{$ref_pep} = { 'index' => $ref_idx, 'position' => $alignment_6->{$reference_}->{$cd8_6}->{'Epitope_homologue_penultimate'}->[$ref_idx], 'found_by_search' => 0 }; $ref_idx++; } } my $target_idx = 0; foreach my $epitope_peptide (@{$alignment_6->{$virus_6}->{$cd8_6}->{'Epitopes'}}){ my $homologue_test = (defined $alignment_6->{$virus_6}->{$cd8_6}->{'Epitope_homologue_penultimate'}->[$target_idx]) ? $alignment_6->{$virus_6}->{$cd8_6}->{'Epitope_homologue_penultimate'}->[$target_idx] : ''; my $flag_6 = 0; my $flag3_6 = 0; my $homologue_gap_end; if (defined $homologue_test && $homologue_test =~ m /\d+\-\d+\-\d+\-\d+/){ ($homologue_gap_end = $homologue_test) =~ s/\d+\-\d+\-\d+\-(\d+)/$1/; $homologue_test =~ s/\d+\-\d+\-(\d+)\-\d+/$1/; $flag_6 = "1"; } else { $flag_6 = 0; } my $found_in_ref = 0; my $ref_pos = 0; my $flag2_6 = 0; my $homologue_ref_gap_end; if (exists $ref_peptides_by_sequence{$epitope_peptide}) { $found_in_ref = 1; $ref_pos = (defined $ref_peptides_by_sequence{$epitope_peptide}->{'position'}) ? $ref_peptides_by_sequence{$epitope_peptide}->{'position'} : 0; } else { my $pep_pos_in_ref = index($ref_protein_seq, $epitope_peptide); if ($pep_pos_in_ref >= 0) { $found_in_ref = 1; $ref_pos = $pep_pos_in_ref + 1; } } if ($found_in_ref) { $flag3_6 = 1; if (defined $ref_pos && $ref_pos =~ m /\d+\-\d+\-\d+\-\d+/){ ($homologue_ref_gap_end = $ref_pos) =~ s/\d+\-\d+\-\d+\-(\d+)/$1/; $ref_pos =~ s/\d+\-\d+\-(\d+)\-\d+/$1/; $flag2_6 = "1"; } else { $homologue_ref_gap_end = (defined $alignment_6->{$virus_6}->{$cd8_6}->{'Size'}->[0] && defined $ref_pos && $ref_pos > 0) ? $alignment_6->{$virus_6}->{$cd8_6}->{'Size'}->[0] + $ref_pos - 1 : 0; } if ($flag_6 == 1 and $flag2_6 == 1){ if ($homologue_ref_gap_end == $homologue_gap_end){ push @homologue_, $homologue_test; } else { push @homologue_, $homologue_test; } } else { push @homologue_, $homologue_test; } } else { push (@homologue_, "0"); } $target_idx++; } $alignment_6->{$virus_6}->{$cd8_6}->{'Epitope_homologue_confirmed'}->{$reference_} = \@homologue_; } } return $alignment_6; }
sub iedb_printout { my ($hash_counts_7, $alignment_7, $cd8_7, $dir_7, $locus, $flag_7, $cd8_type_7) = @_; my $out_dir = $dir_7; (my $cd8_type_8 = $cd8_type_7) =~ s/(\w+)_/_$1/; my $outfile_fin = "$out_dir" . "Global_IEDB_out_" . "$locus" . "$cd8_type_8" . "\.---\.csv"; my $outfile_summary = "$out_dir" . "Summary_IEDB_" . "$locus" . "$cd8_type_8" . "\.---\.csv"; my $size_7; my $ref1_header = $reference_sequences[0] || 'Ref1'; my $ref2_header = $reference_sequences[1] || $ref1_header; my $ref1_name = $ref1_header; my $ref2_name = $ref2_header; $ref1_name =~ s/^([^_\s]+).*/$1/; $ref2_name =~ s/^([^_\s]+).*/$1/; if ($flag_7==0){ open (my $fhout2, '>>', $outfile_summary) or die "The data summary will not open." . "$!", "\n"; print $fhout2 'Peptide query', ",", 'HLA genotype', ",", 'Peptide', ",", "$ref1_name ref", ",", "$ref2_name ref", ",", 'Method', ",", "$ref1_name-like epitopes",",", "$ref1_name amino acid identity", ",", "$ref1_name amino acid diff", ",", 'Total amino acids', ",",  'Average', ",", "$ref2_name amino acid identify", ",", "$ref2_name amino acid diffs", ",", "Average $ref2_name-like", ",", 'Percentile', "\n"; close $fhout2; } open (my $fhout, '>>', "$outfile_fin"); print $fhout 'HLA genotype', ",", "Query", ",", "Peptide", ",", "$ref1_name ref", ",", "$ref2_name ref", ",", 'Epitope loc.', ",", "Method", ",", "Consensus", ",", "ANN", ",", "SMM", ",", "Comblib", ",", "%age id $ref1_name", ",", "%age ID $ref2_name", ",", "No. ID aa with $ref1_name", ",", "No. diff vs $ref1_name", ",", "No. diff vs $ref2_name", ",", "No. ID aa with $ref2_name",",", "Homologue $ref1_name", ",", "Homologue $ref2_name", ",", "Check indels", ",", 'Percentile', "\n"  if $flag_7 == 0; foreach my $virus_7 (sort {$b cmp $a} keys %$alignment_7){ my %method_stats = (); my %peptide_stats = (); my $i_7 = 0; my $ref1 = $reference_sequences[0] || ''; my $ref2 = $reference_sequences[1] || $ref1; foreach my $peptide (@{$alignment_7->{$virus_7}->{$cd8_7}->{'Epitopes'}}){ my $skip_peptide = 1;             my $ref1_passes = 0; if ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}) { my $ref1_hom_val = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] : 0; if ($ref1_hom_val > $PERCENTAGE_IDENTITY_THRESHOLD){ if (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}) { my $ref1_conf_val = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] : 0; if ($ref1_conf_val > 0){ $ref1_passes = 1; } else { $ref1_passes = 1; } } else { $ref1_passes = 1; } } else { $ref1_passes = 1; } } else { $ref1_passes = 1; }
            my $ref2_passes = 0; if ($ref2 && $ref2 ne $ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}) { my $ref2_hom_val = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] : 0; if ($ref2_hom_val > $PERCENTAGE_IDENTITY_THRESHOLD){ if (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}) { my $ref2_conf_val = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] : 0; if ($ref2_conf_val > 0){ $ref2_passes = 1; } else { $ref2_passes = 1; } } else { $ref2_passes = 1; } } else { $ref2_passes = 1; } } else { $ref2_passes = 1; }
            if (!$ref1_passes && !$ref2_passes) { $i_7++; next; }
            my $ref1_peptide = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref1}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref1}->[$i_7] : ''; my $ref2_peptide = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref2}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref2}->[$i_7] : ''; my $ref1_indel = $ref1_peptide; my $ref2_indel = $ref2_peptide; my $ref1_hom_raw = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref1}->[$i_7] : 0; my $ref1_homology = $ref1_hom_raw * 100; my $ref2_hom_raw = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_homology'}->{$ref2}->[$i_7] : 0; my $ref2_homology = $ref2_hom_raw * 100; my $ref1_identity = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1}->[$i_7] : 0; my $ref1_diff = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1}->[$i_7] : 0; my $ref2_identity = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2}->[$i_7] : 0; my $ref2_diff = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2}->[$i_7] : 0; my $ref1_confirmed = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1}->[$i_7] : 0; my $ref2_confirmed = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref2}->[$i_7] : 0; my $method_name = (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Method'}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Method'}->[$i_7] : 'UNKNOWN'; my $comblib_val_raw = (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Comblib'} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Comblib'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Comblib'}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Comblib'}->[$i_7] : 0; my $comblib_val = sprintf("%.1f", $comblib_val_raw); my $method_percentile_raw = (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Method_percentile'} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Method_percentile'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Method_percentile'}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Method_percentile'}->[$i_7] : ((exists $alignment_7->{$virus_7}->{$cd8_7}->{'Consensus'} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Consensus'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Consensus'}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Consensus'}->[$i_7] : 0); my $method_percentile = $method_percentile_raw; my $epi_penultimate = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_penultimate'}->[$i_7]) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_penultimate'}->[$i_7] : 0; my $ann_val_raw = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'ANN'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'ANN'}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'ANN'}->[$i_7] : 0; my $ann_val_print = sprintf("%.1f", $ann_val_raw); my $smm_val_raw = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'SMM'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'SMM'}->[$i_7] =~ /^\d+(\.\d+)?$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'SMM'}->[$i_7] : 0; my $smm_val_print = sprintf("%.1f", $smm_val_raw); my $error_val_raw = (defined $alignment_7->{$virus_7}->{$cd8_7}->{'Error'}->[$i_7] && $alignment_7->{$virus_7}->{$cd8_7}->{'Error'}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Error'}->[$i_7] : 0; my $error_val = $error_val_raw; $epi_penultimate = 0 unless $epi_penultimate =~ /^\d+$/; printf $fhout <<"__EOFOO__", $cd8_7, $virus_7, $peptide, $ref1_indel, $ref2_indel, $epi_penultimate, $method_name, $method_percentile, $ann_val_print, $smm_val_print, $comblib_val, $ref1_homology, $ref2_homology, $ref1_identity, $ref1_diff, $ref2_diff, $ref2_identity, $ref1_confirmed, $ref2_confirmed, $error_val, $method_percentile;
%s,%s,%s,%s,%s,%d,%s,%.3f,%.1f,%.1f,%.1f,%.1f,%.1f,%d,%d,%d,%d,%d,%d,%d,%.3f
__EOFOO__
 my $ref1_stat = $reference_sequences[0] || '';
 my $ref2_stat = $reference_sequences[1] || $ref1_stat;
 $size_7 = $alignment_7->{$virus_7}->{$cd8_7}->{'Size'}->[0];
 my $current_method = (exists $alignment_7->{$virus_7}->{$cd8_7}->{'Method'}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Method'}->[$i_7] : 'UNKNOWN';
 my $current_peptide = $peptide;
 my $current_ref1_pep = ($ref1 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref1}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref1}->[$i_7] : '';
 my $current_ref2_pep = ($ref2 && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref2}) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Indel_epitope_reference'}->{$ref2}->[$i_7] : '';
 my $peptide_method_key = "$current_peptide:$current_method";
 unless (exists $method_stats{$current_method}) { $method_stats{$current_method} = { 'no_amino_acid_diff' => 0, 'identical_amino_acids' => 0, 'JEV_identical_amino_acids' => 0, 'zika_no_epitopes' => 0, 'JEV_amino_acid_diff' => 0, 'total_amino_acids' => 0, 'total_JEV_amino_acids' => 0 }; }
 unless (exists $peptide_stats{$peptide_method_key}) { $peptide_stats{$peptide_method_key} = { 'peptide' => $current_peptide, 'ref1_peptide' => $current_ref1_pep, 'ref2_peptide' => $current_ref2_pep, 'method' => $current_method, 'no_amino_acid_diff' => 0, 'identical_amino_acids' => 0, 'JEV_identical_amino_acids' => 0, 'has_epitope' => 0, 'JEV_amino_acid_diff' => 0, 'total_amino_acids' => 0, 'total_JEV_amino_acids' => 0, 'percentile' => $method_percentile }; }
            if ($ref1_stat && exists $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1_stat} && defined $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1_stat}->[$i_7]) { my $confirmed_val = ($alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1_stat}->[$i_7] =~ /^\d+$/) ? $alignment_7->{$virus_7}->{$cd8_7}->{'Epitope_homologue_confirmed'}->{$ref1_stat}->[$i_7] : 0; my $has_confirmed = ($confirmed_val > 0) ? 1 : 0; $method_stats{$current_method}->{'zika_no_epitopes'}++ if $has_confirmed; $peptide_stats{$peptide_method_key}->{'has_epitope'} = 1 if $has_confirmed; my $aa_diff = defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref1_stat}->[$i_7] : 0; my $aa_identity = defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref1_stat}->[$i_7] : 0; my $total_aa = defined $alignment_7->{$virus_7}->{$cd8_7}->{'all_amino_acids_epitopes'}->{$ref1_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'all_amino_acids_epitopes'}->{$ref1_stat}->[$i_7] : 0; $method_stats{$current_method}->{'no_amino_acid_diff'} += $aa_diff; $method_stats{$current_method}->{'identical_amino_acids'} += $aa_identity; $method_stats{$current_method}->{'total_amino_acids'} += $total_aa; $peptide_stats{$peptide_method_key}->{'no_amino_acid_diff'} += $aa_diff; $peptide_stats{$peptide_method_key}->{'identical_amino_acids'} += $aa_identity; $peptide_stats{$peptide_method_key}->{'total_amino_acids'} += $total_aa; }
 if ($ref2_stat && exists $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2_stat}) { my $jev_diff = defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_differences'}->{$ref2_stat}->[$i_7] : 0; my $jev_identity = defined $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'amino_acid_identity'}->{$ref2_stat}->[$i_7] : 0; my $jev_total = defined $alignment_7->{$virus_7}->{$cd8_7}->{'all_amino_acids_epitopes'}->{$ref2_stat}->[$i_7] ? $alignment_7->{$virus_7}->{$cd8_7}->{'all_amino_acids_epitopes'}->{$ref2_stat}->[$i_7] : 0; $method_stats{$current_method}->{'JEV_amino_acid_diff'} += $jev_diff; $method_stats{$current_method}->{'JEV_identical_amino_acids'} += $jev_identity; $method_stats{$current_method}->{'total_JEV_amino_acids'} += $jev_total; $peptide_stats{$peptide_method_key}->{'JEV_amino_acid_diff'} += $jev_diff; $peptide_stats{$peptide_method_key}->{'JEV_identical_amino_acids'} += $jev_identity; $peptide_stats{$peptide_method_key}->{'total_JEV_amino_acids'} += $jev_total; } $i_7++; } print $virus_7, "\t", $cd8_7, "\t", $alignment_7->{$virus_7}->{'aligned_locus'}, "\t", $dir_7, "\n"; open (my $fh_out2, '>>', $outfile_summary); foreach my $peptide_key (sort keys %peptide_stats) { my $pep_data = $peptide_stats{$peptide_key}; my $method_key = $pep_data->{'method'}; my $pep_identity = $pep_data->{'identical_amino_acids'} || 0; my $pep_diff = $pep_data->{'no_amino_acid_diff'} || 0; my $pep_total_aa = $pep_data->{'total_amino_acids'} || 0; my $pep_has_epitope = $pep_data->{'has_epitope'} || 0; my $pep_jev_identity = $pep_data->{'JEV_identical_amino_acids'} || 0; my $pep_jev_diff = (defined $pep_data->{'JEV_amino_acid_diff'}) ? $pep_data->{'JEV_amino_acid_diff'} : 0; my $pep_jev_total = $pep_data->{'total_JEV_amino_acids'} || 0; my $pep_avg = ($pep_total_aa > 0) ? ($pep_identity / $pep_total_aa) : 0; my $pep_jev_avg = ($pep_jev_total > 0) ? ($pep_jev_identity / $pep_jev_total) : 0; print $fh_out2 $virus_7, ",", $cd8_7, ",", $pep_data->{'peptide'}, ",", $pep_data->{'ref1_peptide'}, ",", $pep_data->{'ref2_peptide'}, ",", $method_key, ",", $pep_has_epitope, ",", $pep_identity, ",", $pep_diff, ",", $pep_total_aa, ",", $pep_avg, ",", $pep_jev_identity, ",", $pep_jev_diff, ",", $pep_jev_avg, ",", $pep_data->{'percentile'}, "\n"; my $method_hash_key = "$virus_7:$method_key"; unless (exists $hash_counts_7->{$method_hash_key}) { $hash_counts_7->{$method_hash_key}->{'ZIKV_aa_identity'} = 0; $hash_counts_7->{$method_hash_key}->{'ZIKV_aa_diff'} = 0; $hash_counts_7->{$method_hash_key}->{'Total_aa'} = 0; $hash_counts_7->{$method_hash_key}->{'No_epitopes'} = 0; $hash_counts_7->{$method_hash_key}->{'JEV_aa_identity'} = 0; $hash_counts_7->{$method_hash_key}->{'JEV_aa_diff'} = 0; } } foreach my $method_key (sort keys %method_stats) { my $stats = $method_stats{$method_key}; my $method_hash_key = "$virus_7:$method_key"; my $method_identity = $stats->{'identical_amino_acids'}; my $method_diff = (defined $stats->{'no_amino_acid_diff'}) ? $stats->{'no_amino_acid_diff'} : "0"; my $method_total_aa = (defined $stats->{'total_amino_acids'}) ? $stats->{'total_amino_acids'} : 0; my $method_jev_identity = (defined $stats->{'JEV_identical_amino_acids'}) ? $stats->{'JEV_identical_amino_acids'} : 0; my $method_jev_diff = (defined $stats->{'JEV_amino_acid_diff'}) ? $stats->{'JEV_amino_acid_diff'} : 0; my $has_data = ($method_total_aa > 0) || ($stats->{'zika_no_epitopes'} > 0) || ($stats->{'total_JEV_amino_acids'} > 0); if ($has_data) { $hash_counts_7->{$method_hash_key}->{'ZIKV_aa_identity'} += $method_identity; $hash_counts_7->{$method_hash_key}->{'ZIKV_aa_diff'} += $method_diff; $hash_counts_7->{$method_hash_key}->{'Total_aa'} += $method_total_aa; $hash_counts_7->{$method_hash_key}->{'No_epitopes'} += $stats->{'zika_no_epitopes'}; $hash_counts_7->{$method_hash_key}->{'JEV_aa_identity'} += $method_jev_identity; $hash_counts_7->{$method_hash_key}->{'JEV_aa_diff'} += $method_jev_diff if $method_jev_diff ne "undef"; } } close $fh_out2; } close $fhout; return ($locus, $size_7, $outfile_fin, $outfile_summary, $hash_counts_7); }
sub file_begin { my ($locus_0, $dir_0, $flag_0, $cd8_type_) = @_; $locus_0 =~ s/\.phy//; my $out_dir = $dir_0; my $store = $out_dir . 'outfile_store'; system ("mkdir -p $store") unless -d $store; }
sub file_clean { my ($locus_8, $dir_8, $size_8, $outfile_8, $summary_8, $cd8_type_8, $store_no_8) = @_; $size_8 = $store_no_8 unless defined $size_8; my $out_dir_8 = $dir_8; (my $cd8_type_9 = $cd8_type_8) =~ s/(\w+)_/_$1/; my $out_dir_9 = $out_dir_8 . 'outfile_store/'; (my $summary_9 = $summary_8) =~ s/(.*Summary_IEDB_.*$locus_8$cd8_type_9\.)---(\.csv)/$1$size_8$2/; system ("mv $summary_8 $summary_9"); system ("mv $summary_9 $out_dir_9"); (my $outfile_9 = $outfile_8) =~ s/(.*Global_IEDB_out_.*$locus_8$cd8_type_9\.)---(\.csv)/$1$size_8$2/; system ("mv $outfile_8 $outfile_9"); system ("mv $outfile_9 $out_dir_9"); (my $summary_name = $summary_9) =~ s/.*\/(.*)/$1/; $summary_9 = $out_dir_9 . $summary_name; return $summary_9; }
sub final_average { my ($hash_counts_, $summary_10) = @_; $summary_10 =~ s/Summary/Sum_totals/; my %hash_brown = %{$hash_counts_}; my $ref1_header_final = $reference_sequences[0] || 'Ref1'; my $ref2_header_final = $reference_sequences[1] || $ref1_header_final; my $ref1_name_final = $ref1_header_final; my $ref2_name_final = $ref2_header_final; $ref1_name_final =~ s/^([^_\s]+).*/$1/; $ref2_name_final =~ s/^([^_\s]+).*/$1/; open (my $fh_out3, '>', "$summary_10"); print $fh_out3 'Query', ",", 'Method', ",", "Trans-$ref1_name_final epitopes", ",", "$ref1_name_final aa identity", ",","$ref1_name_final aa diffs", ",", 'Total aa', ",", "$ref2_name_final aa identity", ",", "$ref2_name_final aa diffs", "\n"; my %grouped = (); foreach my $key (keys %hash_brown) { if ($key =~ /^(.*):(.+)$/) { my $virus = $1; my $method = $2; $grouped{$virus}->{$method} = $hash_brown{$key}; } else { $grouped{$key}->{'ALL'} = $hash_brown{$key}; } } foreach my $virus_key (sort {$b cmp $a} keys %grouped) { foreach my $method_key (sort keys %{$grouped{$virus_key}}) { my $data = $grouped{$virus_key}->{$method_key}; print $fh_out3 $virus_key, ",", $method_key, ",", ($data->{'No_epitopes'} || 0), ",", ($data->{'ZIKV_aa_identity'} || 0), ",", ($data->{'ZIKV_aa_diff'} || 0), ",", ($data->{'Total_aa'} || 0), ",", ($data->{'JEV_aa_identity'} || 0), ",", ($data->{'JEV_aa_diff'} || 0), "\n"; } } close $fh_out3; print "Calculation is completed" . "\n"; }
__END__


